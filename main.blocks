<xml xmlns="https://developers.google.com/blockly/xml"><variables><variable id="g*1r]s+6q*;Z]OVB9tn9">msg</variable><variable id="r.8lTbZSf2$x79e6{6M0">messages</variable><variable id="ZsGX5OnbN*FpiQR2bZdN">brightness</variable><variable id="A%O%#okEvC?7Co:gQF0s">pulses</variable><variable id="Bm{D1CmbR!U=nk^2BNbW">systemCommand</variable></variables><block type="pxt-on-start" id=",{tzaG]vedeuYnjws,|+" x="0" y="0"><statement name="HANDLER"><block type="typescript_statement" id="`aR1;Q_K)t#h(+LZgbnp" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="let systemStatusTimer = 0" numlines="1" declaredvars="systemStatusTimer"></mutation><next><block type="typescript_statement" id="`3aDn[KOb7k7t}E,P,Rm" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="let messages: MidiMessage[] = []" numlines="1" declaredvars="messages"></mutation><next><block type="variables_set" id="bJ2]i6xE8Dy[6GVBp*Ry"><field name="VAR" id="A%O%#okEvC?7Co:gQF0s">pulses</field><value name="VALUE"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="lists_create_with" id="`~(e47nud]Z~^zJTMQ@["><mutation items="0" horizontalafter="3"></mutation></block></value><next><block type="variables_set" id="@4O]r!Z2FrpI4|A4$Vi-"><field name="VAR" id="Bm{D1CmbR!U=nk^2BNbW">systemCommand</field><value name="VALUE"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="logic_boolean" id="KRlH:b/Lo/zHq*/p8?Y+"><field name="BOOL">FALSE</field></block></value><next><block type="typescript_statement" id="FxH%u*hFikZ4s6}I,zUx" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="let msg: string[] = []" numlines="1" declaredvars="msg"></mutation><next><block type="typescript_statement" id="+s+(G55+l[xd-#(DX5?G" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="namespace ensemble {" line1="    enum ChannelBand {" line2="        Albatross = 1," line3="        Bananaquit = 2," line4="        Cassowary = 3," line5="        Doterrel = 4," line6="        Emu = 5," line7="        Finch = 6," line8="        Gargeney = 7," line9="        Hoatzin = 8," line10="        Idisbill = 9," line11="        Killdeer = 10," line12="        Lyrebird = 11," line13="        Martin = 12," line14="        Nightingale = 13," line15="        Osprey = 14," line16="        Partridge = 15," line17="        // Quetzal=16" line18="    }" line19="" line20="    /**" line21="     * Say Hello" line22="     */" line23="    //% block=&quot;[Basic] My Block Name&quot;" line24="    export function sayHello(): void {" line25="        basic.showString(&quot;Hello&quot;)" line26="    }" line27="}" numlines="28"></mutation><next><block type="typescript_statement" id="N{ObQKUwErj#FiN`*E%o" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="enum STATE {" line1="    IDLE," line2="    TRANSMITTING," line3="    ERROR" line4="}" numlines="5"></mutation><next><block type="typescript_statement" id="-J6)n7KRmU:XO1X|xs+D" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="let state: STATE = STATE.TRANSMITTING;" numlines="1" declaredvars="state"></mutation><next><block type="typescript_statement" id="uP/?plDooeNzE19mxfuo" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="interface MidiMessage {" line1="    command: MidiCommand" line2="    channel?: number" line3="    data1?: number" line4="    data2?: number" line5="}" numlines="6"></mutation><next><block type="typescript_statement" id="6r{yEU^#6l=cB#LZTfzM" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="enum MidiCommand {" line1="    Clock = 248," line2="    Start = 250," line3="    Continue = 251," line4="    Stop = 252," line5="    NoteOn = 9," line6="    NoteOff = 8" line7="}" numlines="8"></mutation><next><block type="variables_set" id="ceW9088BRm?182a|utgD"><field name="VAR" id="ZsGX5OnbN*FpiQR2bZdN">brightness</field><value name="VALUE"><shadow type="math_number" id="=7kB`xw;`T|6x59Vfwai"><field name="NUM">100</field></shadow></value><next><block type="typescript_statement" id="+klDr`lG0Hlzp0eKAjAf" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="let commandDisplayed: MidiCommand" numlines="1" declaredvars="commandDisplayed"></mutation><next><block type="typescript_statement" id="xw45I*P`;Y}kR%z=yyct" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="class Pulse {" line1="    pin: DigitalPin" line2="    start: number" line3="    duration: number" line4="" line5="    constructor(pin: DigitalPin, duration?: number) {" line6="        this.pin = pin;" line7="        this.start = input.runningTime();" line8="        this.duration = duration | 40;" line9="    }" line10="}" numlines="11"></mutation><next><block type="serialSetTxBufferSize" id="=I3:|@ZXwtfV@9v?a5~H"><value name="size"><shadow type="math_number" id="WFMQ~)dM2}ot7|_xUI)f"><field name="NUM">64</field></shadow></value><next><block type="serialSetRxBufferSize" id="Dx79qaKroA{g@#P/bHn5"><value name="size"><shadow type="math_number" id="|UCgp;JO7qXmUpk?|f__"><field name="NUM">64</field></shadow></value><next><block type="serial_setbaudrate" id="4qBleC[v{y!lC!Ikb2MD"><field name="rate">BaudRate.BaudRate115200</field><next><block type="serial_redirect_to_usb" id="5sSAsfufg6nDWZ2`TbLD"><next><block type="typescript_statement" id="Z(X]i3SKv:qG;i$20yW^" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="basic.showIcon(IconNames.Happy, 0);" numlines="1"></mutation></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></statement></block><block type="device_forever" id="bP?+/4yajqPY}1zqbPJn" x="586" y="0"><statement name="HANDLER"><block type="typescript_statement" id="Me02rZ!Dj,[*?|!ej0lc" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="switch (state) {" line1="        case STATE.IDLE:" line2="            break;" line3="        case STATE.TRANSMITTING:" line4="            commandDisplayed = undefined;" line5="            if (systemStatusTimer == 0 &amp;&amp; messages.length &gt; 0) {" line6="                commandDisplayed = MidiCommand.NoteOff;" line7="                for (const msg2 of messages) {" line8="                    if (msg2.command &gt; 248) {" line9="                        systemStatusTimer = 30;" line10="                        commandDisplayed = msg2.command;" line11="                        break;" line12="                    }" line13="                    else if (msg2.command === MidiCommand.NoteOn) {" line14="                        commandDisplayed = MidiCommand.NoteOn;" line15="                        // let note = (1 &lt;&lt; 7 || msg.data1) &amp;&amp; 0xFF" line16="                        let note = (1 &lt;&lt; 14 || msg2.data1 &lt;&lt; 7 || msg2.data2) &amp;&amp; 0xFFFF;" line17="" line18="                        radio.sendNumber(note)" line19="                        // pulses.push(new Pulse())" line20="                    }" line21="                }" line22="                messages = []" line23="            } else if (systemStatusTimer &gt; 0) {" line24="                systemStatusTimer -= 1;" line25="            }" line26="            switch (commandDisplayed) {" line27="                case MidiCommand.Continue:" line28="                case MidiCommand.Start:" line29="                    basic.showLeds(`" line30="            . # . . ." line31="            . # # . ." line32="            . # # # ." line33="            . # # . ." line34="            . # . . ." line35="            `, 0);" line36="                    break;" line37="                case MidiCommand.Stop:" line38="                    basic.showLeds(`" line39="            # # . # #" line40="            # # . # #" line41="            # # . # #" line42="            # # . # #" line43="            # # . # #" line44="            `, 0);" line45="                    break;" line46="                case MidiCommand.NoteOn:" line47="                    basic.showIcon(IconNames.Surprised, 0);" line48="                    break;" line49="                case MidiCommand.NoteOff:" line50="                    basic.showIcon(IconNames.Happy, 0);" line51="                    break;" line52="            }" line53="            break;" line54="        case STATE.ERROR:" line55="            basic.showIcon(IconNames.Skull, 0);" line56="            break;" line57="    }" numlines="58"></mutation></block></statement></block><block type="serial_on_data_received" id="8;o5oXQIf%(vixxCe%jC" x="1508" y="0"><value name="delimiters"><shadow type="serial_delimiter_conv" id="TPKfo8-VA~4bosz:{Rrg"><field name="del">Delimiters.NewLine</field></shadow></value><statement name="HANDLER"><block type="variables_set" id="lb,tO]$:c?@z=n/WH1}Q"><field name="VAR" id="g*1r]s+6q*;Z]OVB9tn9">msg</field><comment pinned="false" h="80" w="160">add midi messages from (read newline) to [messages]</comment><value name="VALUE"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="string_split" id=",;tcQ[HXf.Y;5}zE%;^X"><value name="this"><shadow type="text"><field name="TEXT"></field></shadow><block type="serial_read_line" id="M$BK.C#nn(%}pO]KmK5/"></block></value><value name="separator"><shadow type="text" id="(v:mDRf(s+gLL!UBLYT%"><field name="TEXT">,</field></shadow></value></block></value><next><block type="controls_if" id="A|=Gg5yg23?4OW*D1t~L"><mutation elseif="1" else="1"></mutation><value name="IF0"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="logic_compare" id="AiB_t7^i3d4F`O:bf0r/"><field name="OP">GT</field><value name="A"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="lists_index_get" id="jSc8QI^^Eq}?b5m^(2Ws"><value name="LIST"><block type="variables_get" id="p_p;F3EnSrH_b,Udpp79"><field name="VAR" id="g*1r]s+6q*;Z]OVB9tn9">msg</field></block></value><value name="INDEX"><shadow type="math_number" id="}-Cn|eFK1s?(9%80LBg@"><field name="NUM">0</field></shadow></value></block></value><value name="B"><shadow type="math_number" id="$.NF3L/V-=#G{)Pf/lHs"><field name="NUM">248</field></shadow></value></block></value><statement name="DO0"><block type="array_push" id="xFeo1r%XK%_.w]6A7CBJ"><value name="list"><block type="variables_get" id="2p8_Q9:+$7r%;#Dl1[+N"><field name="VAR" id="r.8lTbZSf2$x79e6{6M0">messages</field></block></value><value name="value"><block type="typescript_expression" id="=~p@RZA):C7W*9ER.#*N" editable="false"><field name="EXPRESSION">{
            command: +msg[0]
        }</field></block></value></block></statement><value name="IF1"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="logic_compare" id="4K#$Y@`+*@DgQ.9Qd6s/"><field name="OP">EQ</field><value name="A"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="lists_index_get" id="lvXPFnJvI8Jl6iXCGIwc"><value name="LIST"><block type="variables_get" id="NjV[sYKV/]qPgUc0`Op)"><field name="VAR" id="g*1r]s+6q*;Z]OVB9tn9">msg</field></block></value><value name="INDEX"><shadow type="math_number" id="JHnOsap*;Dy5~2y/)l:c"><field name="NUM">0</field></shadow></value></block></value><value name="B"><shadow type="math_number" id=";(P!MeEVsVYpq8wQjFX`"><field name="NUM">248</field></shadow></value></block></value><statement name="DO1"><block type="variables_set" id="qI(@A#J$,|i_wv1?J[E("><field name="VAR" id="ZsGX5OnbN*FpiQR2bZdN">brightness</field><value name="VALUE"><shadow type="math_number" id="aS[jso]6Lo3%77^J8bh:"><field name="NUM">255</field></shadow></value></block></statement><statement name="ELSE"><block type="typescript_statement" id="1Ter.kM(S`|%v%o@k?1/" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="let command = (+msg[0] &gt;&gt; 4) &amp; 0x0F;" numlines="1" declaredvars="command"></mutation><next><block type="typescript_statement" id="l@OV#;[EV3,4XX,*NzMe" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="let channel = +msg[0] &amp; 0x0F;" numlines="1" declaredvars="channel"></mutation><next><block type="array_push" id="O%6]ee1j#ne~M9ApKY(_"><value name="list"><block type="variables_get" id="M#3Ywp,C!fIXca`7fU%N"><field name="VAR" id="r.8lTbZSf2$x79e6{6M0">messages</field></block></value><value name="value"><block type="typescript_expression" id="roa^p/oa!-Pj`_*x{K7#" editable="false"><field name="EXPRESSION">{
            command,
            channel,
            data1: msg[1] ? +msg[1] : undefined,
            data2: msg[2] ? +msg[2] : undefined
        }</field></block></value></block></next></block></next></block></statement></block></next></block></statement></block></xml>